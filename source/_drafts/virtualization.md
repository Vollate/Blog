---
title: 浅记系统虚拟化
date: 2023-11-09 19:24:06
tags:
- Note
categories:
- OS
---
最近由于项目需要学习以下虚拟化的知识，于是在师兄的建议下读了 sjtu 出的新书[《操作系统原理与实践》](https://ipads.se.sjtu.edu.cn/ospi/)中的系统虚拟化的部分，记点笔记。

**虚拟化发展历史:**

- 1960s出现分时操作系统概念。同时期IBM进行了另一个方向也就是虚拟化的探索，并在1968年的system360上实现了第一个VMM(Virtual Machine Monitor) _CP/CMS_
- 1980s，开始出现纯软件实现的虚拟机监视器
- 1990s, 互联网兴起，web服务器逐渐性能过剩
- 1998年，VMware成立。
- 云计算兴起，虚拟化越发重要

**优势:**

- 充分利用服务器，甚至可以错峰来达成超售
- 虚拟机管理更为便捷，可以快速部署销毁
- 可以热迁移
- VMI(Virtual Machine Introspection 虚拟机自省)可以从外部检查虚拟机是否被入侵

## 系统虚拟化概述

### 组成部分

- CPU 虚拟化（vCPU）：若虚拟化的指令集和物理架构指令集相同，除了部分特殊指令其他都可以直接执行，效率较高（KVM）；若架构不同，则需要全部转译执行。
- 内存虚拟化：引入虚拟物理地址，内存访问需要多经过一层虚拟物理地址到物理地址的映射操作。
- I/O 虚拟化：VMM 提供虚拟驱动供虚拟机使用，并将操作转化为实际的物理设备访问或其他操作。

### VMM 类型

- 半虚拟化: 运行在最高权限级别，相当于一个以OS作为进程的操作系统，如 Xen。
- 完全虚拟化：作为一个进程运行在 OS 上，复用宿主OS的线程调度和资源管理，如 QEMU。

## Trap-Emulate（下陷-模拟）

Trap：将系统级ISA拦截转为 VMM 进行操作。如系统调用先转化为虚拟机内核态，然后由 VMM 拦截并完成对应调用的实现。

Emulate：用软件模拟执行后的效果

### 基础知识

- CPU 上下文：指CPU在执行特定进程或任务时所需的信息集合。一般包括该CPU的所有寄存器（包括PC）的值和当前系统状态（内存信息，调度优先级等）。
- 中断向量表（Interrupt Vector Table）：存放中断处理函数。
- 中断处理过程：触发中断时，首先检查中断是否开启。若开启，CPU 接收中断信号并暂停当前程序处理。然后保存当前上下文以供恢复。然后确定中断类型并从中断向量表中查找对应处理函数的地址并跳转执行。执行结束后，恢复中断前的上下文。
- 用户态：用户态是普通应用程序运行的模式。该模式下，程序对硬件的访问受限，一般通过OS提供系统调用切换到内核态来执行对应函数进行访问。
- 内核态：OS 一般运行在该状态下。该状态下，OS 能够完全访问并操作硬件，访问所有内存。

### Trap-Emulate 虚拟化实现

VMM 需提供数据结构，来存储原本存储在物理 CPU 上的所有进程上下文信息，以及对应的其它信息（如中断向量表,虚拟页表等）。

- 处理中断：对于硬件中断，将会触发 VMM 查看虚拟机是否开启对应中断。如开启，虚拟机保存上下文后下陷到 VMM，然后 VMM 检查中断向量表处理中断。
- 处理系统调用：同中断处理的模式，只是 VMM 需要隔离用户态和内核态的页表映射
- 处理线程切换：本质软件中断到内核态然后进行线程调度，切换进程上下文即可。
- 多 CPU 模拟：加个数据结构存进程上下文和 vCPU 的对应关系就行。vCPU 调度参考 OS 的进程调度，或者直接用线程 OS 进程来实现。

## CPU虚拟化

## 内存虚拟化

## I/O虚拟化

